# Bank-Server
Реализован многопоточный мини-банк с безопасной системой транзакций и поддержкой сетевого взаимодействия.

```bash
./bank-server <port> <port-file>
```

При запуске приложение автоматически поднимает TCP-сервер на указанном порту. Если в качестве порта передано значение 0, сервер использует механизм автоматического выбора свободного порта через tcp::endpoint, что удобно при параллельном запуске нескольких экземпляров на одной машине — например, для тестирования. Выбранный сервером порт сохраняется в указанный файл. Если сохранить порт не удалось, программа выводит в стандартный поток ошибок сообщение вида: `Unable to store port to file <port-file>`.

После запуска сервер начинает принимать текстовые команды от клиента. Каждая команда представляет собой строку, в которой ключевое слово и аргументы разделяются пробелами. Поддерживаются следующие команды:
* `balance` — сервер возвращает текущее состояние баланса пользователя в виде одного целого числа.
* `transactions <n>` — клиент получает информацию о последних n транзакциях пользователя.
* `monitor <n>` — действует как transactions <n>, но после вывода всех текущих транзакций сервер продолжает бесконечно отправлять новые транзакции пользователя по мере их появления. Команда предназначена для отслеживания транзакционной активности в реальном времени.
* `transfer <counterparty> <amount> <comment>` — инициирует перевод суммы <amount> пользователю <counterparty> с комментарием <comment>. Пример корректной команды: transfer Bob 100 Some real comment. В случае успеха сервер отвечает OK\n, при ошибке — текстом исключения (.what()), завершённым переводом строки. Если получатель перевода ранее не существовал, он автоматически создаётся.
* `Unknown command: '<введённая-команда>'` — если введённая строка не соответствует ни одной из поддерживаемых команд.

Особенности:
* Все операции потокобезопасны, включая одновременное использование одного аккаунта несколькими TCP-клиентами.
* Пользователи создаются "по требованию" и получают стартовый баланс 100 XTS.
* Поддерживается атомарное создание итератора и чтение состояния пользователя, исключающее гонки и потерю транзакций.
* Реализован полноценный TCP-сервер на `boost::asio::ip::tcp::iostream` с состоянием сессии, обрабатывающий несколько клиентов одновременно.
* Сервер реализует stateful-протокол, соответствующий спецификации и покрыт тестами.

Основные компоненты:
* `bank::ledger` — центральный гроссбух, хранящий всех пользователей и транзакции, потокобезопасен.
* `bank::user` — структура для работы с пользователем: получение баланса, истории, отправка перевода.
* `bank::transaction` — единица перевода между пользователями, с фиксацией времени и суммы.
* `bank::transfer_error` — кастомные исключения при некорректных транзакциях (например, нехватка средств).
* `bank::user_transactions_iterator` — блокирующий итератор, позволяющий наблюдать за приходом новых транзакций у пользователя в реальном времени.

## Инструкция по запуску
Перейти в папку проекта и построить его:
```bash
mkdir build && cd build && cmake .. && make
```
Приложение bank-server будет лежать в папке build

**Тестирование**\
Из папки build построить и запустить тесты:
```bash
make tests
```
```bash
./../test/run-test-data.sh
```

К проекту опубликована лишь часть тестов.\
Добавить свои юнит-тесты можно в файлы `bank_test.cpp` и `server_test.cpp`. Править скрипт или команды не требуется